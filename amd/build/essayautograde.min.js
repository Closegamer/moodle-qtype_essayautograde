define ("qtype_essayautograde/essayautograde",["jquery","core/str"],function(a,b){var c={plugin:"qtype_essayautograde",str:{},itemtype:"",itemmatch:"",minwords:0,maxwords:0,editortype:"",editormaxtries:50,editorinterval:100,responsesample:"",responseoriginal:""};c.init=function(a,b,d,e,f,g){var h="";switch(b){case"chars":h=".";break;case"words":h="\\w+";break;case"sentences":h="[^\\.?!]+[\\.?!]";break;case"paragraphs":h="[^\\r\\n]+[\\r\\n]*";break;}c.itemtype=b;c.itemmatch=new RegExp(h,"g");c.minwords=d;c.maxwords=e;c.editortype=f;if(a){c.setup_read_only_files();c.setup_response_heights()}else{c.setup_itemcounts();c.setup_responsesample(g)}};c.setup_read_only_files=function(){b.get_strings([{key:"rotate",component:c.plugin},{key:"scale",component:c.plugin},{key:"overflow",component:c.plugin},{key:"auto",component:c.plugin},{key:"hidden",component:c.plugin},{key:"visible",component:c.plugin},{key:"actions",component:"moodle"},{key:"crop",component:c.plugin},{key:"reset",component:"moodle"},{key:"save",component:"moodle"}]).done(function(a){var b=0;c.str.rotate=a[b++];c.str.scale=a[b++];c.str.overflow=a[b++];c.str.auto=a[b++];c.str.hidden=a[b++];c.str.visible=a[b++];c.str.actions=a[b++];c.str.crop=a[b++];c.str.reset=a[b++];c.str.save=a[b++];document.querySelectorAll(".attachments .read-only-file.image .img-responsive").forEach(function(a){if(a.dataset.buttons_added){return!0}a.dataset.buttons_added=!0;a.classList.add("border-0");a.classList.add("m-0");a.classList.add("p-0");var b=document.createElement("DIV");b.classList.add("border-0");b.classList.add("m-0");b.classList.add("p-0");b.classList.add("position-relative");b.classList.add("image-container");a.parentNode.insertBefore(b,a);b.appendChild(a);a.style.transitionDuration="1s";b.style.transitionDuration="1s";if(a.complete){c.set_image_dimensions(a,b)}else{a.onload=function(){c.set_image_dimensions(this,this.parentNode)}}var d=document.createElement("DIV");d.classList.add("border-0");d.classList.add("m-0");d.classList.add("p-0");d.classList.add("buttonsets");var e="overflow",f=c.str[e],g=[],h=["visible","auto","hidden"];for(var j in h){var k=h[j],l=c.str[k],m={value:k};g.push(c.create_button(e,l,m,c.transform_image))}d.appendChild(c.create_buttonset(e,f,g));var e="rotate",f=c.str[e],g=[],h=[0,90,180,270];for(var j in h){var k=h[j],l=k+"\xB0",m={value:k};g.push(c.create_button(e,l,m,c.transform_image))}d.appendChild(c.create_buttonset(e,f,g));var e="scale",f=c.str[e],g=[],h=[.5,1,1.5,2];for(var j in h){var k=h[j],l="\xD7"+k,m={value:k};g.push(c.create_button(e,l,m,c.transform_image))}d.appendChild(c.create_buttonset(e,f,g));b.parentNode.insertBefore(d,b.nextElementSibling)})})};c.set_image_dimensions=function(a,b){a.dataset.width=a.offsetWidth;a.dataset.height=a.offsetHeight;a.dataset.offset=a.offsetWidth-a.offsetHeight;a.dataset.ratio=a.offsetWidth/a.offsetHeight;b.dataset.width=b.offsetWidth;b.dataset.height=b.offsetHeight;b.style.height=b.dataset.height+"px";b.style.width=b.dataset.width+"px";a.style.position="absolute";a.setAttribute("draggable","true");a.addEventListener("dragstart",c.image_dragstart,!1);a.addEventListener("drag",c.image_drag,!1);a.addEventListener("dragend",c.image_dragend,!1)};c.image_dragstart=function(a){this.style.transitionDuration="0s";this.dataset.evtPageY=a.pageY;this.dataset.evtPageX=a.pageX;this.dataset.imgOffsetTop=this.offsetTop;this.dataset.imgOffsetLeft=this.offsetLeft};c.image_drag=function(a){if(a.pageX&&a.pageY){var b=a.pageY-this.dataset.evtPageY,c=a.pageX-this.dataset.evtPageX,d=parseInt(this.dataset.imgOffsetTop),e=parseInt(this.dataset.imgOffsetLeft);this.style.top=d+b+"px";this.style.left=e+c+"px"}};c.image_dragend=function(a){this.style.transitionDuration="1s";if(a.preventDefault){a.preventDefault()}if(a.stopPropagation){a.stopPropagation()}return!1};c.create_buttonset=function(a,b,c){var d=document.createElement("DIV");d.classList.add("bg-secondary");d.classList.add("rounded");d.classList.add("mt-1");d.classList.add("pl-1");d.classList.add("buttonset");if(a){d.classList.add(a+"-buttonset")}if(b){var e=document.createElement("SPAN");e.classList.add("font-weight-bold");e.appendChild(document.createTextNode(b+":"));d.appendChild(e)}if(c){for(var f in c){d.appendChild(c[f])}}return d};c.create_button=function(a,b,c,d){var e=document.createElement("BUTTON");e.setAttribute("type","button");e.classList.add("button");e.classList.add("button-light");e.classList.add("border");e.classList.add("rounded");e.classList.add("my-1");e.classList.add("ml-1");e.classList.add("mr-0");e.classList.add("px-2");if(a){e.classList.add(a+"-button")}if(b){e.appendChild(document.createTextNode(b))}if(c){for(var f in c){e.dataset[f]=c[f]}}if(d){e.addEventListener("click",d,!1)}return e};c.transform_image=function(){var a=this.parentNode;if(!a.matches(".buttonset")){return!1}a.querySelectorAll(".btn-info").forEach(function(a){c.deselect_button(a)});c.select_button(this);var b=a.parentNode;if(!b.matches(".buttonsets")){return!1}var d=b.previousElementSibling;if(!d.matches(".image-container")){return!1}var e=d.querySelector("img");if(!e){return!1}var f="reset"==this.dataset.value,g="visible",i=b.querySelector(".overflow-buttonset .btn-info");if(i){if(f){i=c.set_default_button(i,"overflow",g)}g=i.dataset.value}var j=0,i=b.querySelector(".rotate-buttonset .btn-info");if(i){if(f){i=c.set_default_button(i,"rotate",j)}j=i.dataset.value}var k=1,i=b.querySelector(".scale-buttonset .btn-info");if(i){if(f){i=c.set_default_button(i,"scale",k)}k=i.dataset.value}var l=e.style.transform;l=l.replace(/ *(rotate|scale|translate) *\([^)]*\)/g,"");if(j){l+=" rotate("+j+"deg)"}if(90==j||270==j){if("visible"==g){k*=e.dataset.ratio}var m=e.dataset.offset*k;if(270==j){m=-m}l+=" translate("+m/2+"px, "+m/2+"px)"}e.style.transform=l.trim();e.style.maxWidth="initial";e.style.width=e.dataset.width*k+"px";var n=0;if(90==j||270==j){n=d.dataset.width}else{n=d.dataset.height}if("visible"==g||1>k){n*=k}d.style.overflow=g;d.style.height=n+"px";if(f){c.deselect_button(this)}};c.select_button=function(a){a.classList.remove("btn-light");a.classList.add("btn-info")};c.deselect_button=function(a){a.classList.remove("btn-info");a.classList.add("btn-light")};c.set_default_button=function(a,b,d){if(a.dataset.value==d){return a}c.deselect_button(a);a=a.parentNode.querySelector("."+b+"-button[data-value=\""+d+"\"]");if(a){a.classList.remove("btn-light");a.classList.add("btn-info")}return a};c.setup_response_heights=function(){a("textarea.qtype_essay_response").each(function(){a(this).height(1);a(this).height(this.scrollHeight)})};c.setup_itemcounts=function(){a(".qtype_essay_response").each(function(){var b=c.get_itemcount_id(this),d=a.Deferred();c.check_editor(this,d);a.when(d).done(a.proxy(function(){c.create_itemcount(this,b);c.setup_itemcount(this,b)},this,b))})};c.check_editor=function(b,d){var e="";switch(c.editortype){case"atto":e="[contenteditable=true]";break;case"tinymce":e="iframe";break;}if(""==e){d.resolve()}else{var f=setInterval(function(){if(a(b).find(e).length){clearInterval(f);d.resolve()}},c.editorinterval)}};c.create_itemcount=function(a,d){if(null===document.getElementById(d)){var e=document.createElement("DIV");e.setAttribute("id",d);e.setAttribute("class","itemcount");if("words"==c.itemtype){b.get_strings([{key:"maxwordslabel",component:c.plugin},{key:"maxwordswarning",component:c.plugin},{key:"minwordslabel",component:c.plugin},{key:"minwordswarning",component:c.plugin},{key:"countwordslabel",component:c.plugin}]).done(function(a){var d=0;c.str.maxwordslabel=a[d++];c.str.maxwordswarning=a[d++];c.str.minwordslabel=a[d++];c.str.minwordswarning=a[d++];c.str.countwordslabel=a[d++];var f=document.createElement("B");f.setAttribute("class","label");f.appendChild(document.createTextNode(c.str.countwordslabel+": "));var d=document.createElement("I");d.setAttribute("class","value");d.appendChild(document.createTextNode("0"));var a=document.createElement("SPAN");a.setAttribute("class","wordswarning rounded bg-danger text-light ml-2 px-2 py-1 d-none");var g=document.createElement("P");g.setAttribute("class","countwords mt-2 mb-0");g.appendChild(f);g.appendChild(d);g.appendChild(a);e.appendChild(g);if(c.minwords){f=document.createElement("B");f.setAttribute("class","label");f.appendChild(document.createTextNode(c.str.minwordslabel+": "));d=document.createElement("I");d.setAttribute("class","value");d.appendChild(document.createTextNode(c.minwords));g=document.createElement("P");g.setAttribute("class","minwords my-0");g.appendChild(f);g.appendChild(d);e.appendChild(g)}if(c.maxwords){f=document.createElement("B");f.setAttribute("class","label");f.appendChild(document.createTextNode(c.str.maxwordslabel+": "));d=document.createElement("I");d.setAttribute("class","value");d.appendChild(document.createTextNode(c.maxwords));g=document.createElement("P");g.setAttribute("class","maxwords my-0");g.appendChild(f);g.appendChild(d);e.appendChild(g)}})}else{b.get_strings([{key:c.itemtype,component:c.plugin}]).done(function(a){c.str.countitems=a[0];var d=document.createElement("B");d.setAttribute("class","label");d.appendChild(document.createTextNode(c.str.countitems+": "));var b=document.createElement("I");b.setAttribute("class","value");b.appendChild(document.createTextNode("0"));var f=document.createElement("P");f.setAttribute("class","countitems my-0");f.appendChild(d);f.appendChild(b);e.appendChild(f)})}a.parentNode.insertBefore(e,a.nextSibling)}};c.setup_itemcount=function(b,d){var e=c.get_editable_element(b);if(e){a(e).keyup(function(){c.show_itemcount(this,d)});c.show_itemcount(e,d)}};c.get_editable_element=function(b){if("TEXTAREA"==a(b).prop("tagName")){return b}var c=a(b).find("[contenteditable=true]");if(c.length){return c.get(0)}var e=b.getElementsByTagName("IFRAME");if(e.length){e=e[0];var f=e.contentWindow||e.contentDocument;if(f.document){f=f.document}if(f.body&&f.body.isContentEditable){return f.body}}var c=a(b).find("textarea");if(c.length){return c.get(0)}return null};c.get_textarea=function(b){if("TEXTAREA"==a(b).prop("tagName")){return b}return a(b).find("textarea").get(0)};c.get_textarea_name=function(b){var d=c.get_textarea(b);return a(d).attr("name")};c.get_itemcount_id=function(a){var b=c.get_textarea_name(a);return"id_"+b+"_itemcount"};c.escaped_id=function(a){return"#"+a.replace(/(:|\.|\[|\]|,|=|@)/g,"\\$1")};c.show_itemcount=function(b,d){if("TEXTAREA"==a(b).prop("tagName")){var e=a(b).val().match(c.itemmatch)}else{var e=a(b).text().match(c.itemmatch)}if(e){e=e.length}else{e=0}d=c.escaped_id(d);if("words"==c.itemtype){a(d+" .countwords .value").text(e);var f="";if(e){if(c.minwords&&c.minwords>e){f=c.str.minwordswarning}if(c.maxwords&&c.maxwords<e){f=c.str.maxwordswarning}}var g=document.querySelector(d+" .countwords .wordswarning");if(g){g.innerText=f;if(""==f){g.classList.add("d-none")}else{g.classList.remove("d-none")}}}else{a(d+" .countitems .value").text(e)}};c.setup_responsesample=function(d){if(""==d){return}c.responsesample=d;b.get_strings([{key:"hidesample",component:c.plugin},{key:"showsample",component:c.plugin}]).done(function(b){var d=0;c.str.hidesample=b[d++];c.str.showsample=b[d++];var e=a(".qtext").find("p:not(:empty), div:not(:empty)");if(e.length){e=e.last()}else{e=a(".qtext")}e.append(a("<span></span>").click(function(){var b="",d="",e=!1;if(a(this).hasClass("showsample")){a(this).removeClass("showsample").addClass("hidesample").text(c.str.hidesample);b=c.responsesample;e=!0}else{a(this).removeClass("hidesample").addClass("showsample").text(c.str.showsample);b=c.responseoriginal}var f=null,g=a(this).closest(".qtext");if("audio"==c.editortype||"video"==c.editortype){f=g.find(".audiovideo_response_prompt")}else{var h=g.next(".ablock").find(".answer .qtype_essay_response");if(h.is("[name$='_answer']")){f=h}else{f=h.find("[contenteditable=true]");if(0==f.length){f=h.find("iframe").contents().find("[contenteditable=true]");if(0==f.length){f=h.find("[name$='_answer']")}}}}if(null===f||0==f.length){return!1}if("TEXTAREA"==f.prop("tagName")){d=f.val();f.val(b).keyup()}else{d=f.text();f.text(b).keyup()}if(e){c.responseoriginal=d}return!0}).trigger("click"))})};return c});
//# sourceMappingURL=essayautograde.min.js.map
